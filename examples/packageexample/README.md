# Strata Package Example: string-utils

This directory demonstrates how to create and distribute a Strata package.

## Package Structure

```
string-utils/
├── strata.toml              # Package manifest (REQUIRED)
├── src/
│   └── string.str           # Package implementation
├── README.md                # Documentation
└── example_usage.str        # Example of consuming the package
```

## Files Explained

### strata.toml - Package Manifest

The package manifest declares:

```toml
[project]
name = "string-utils"           # Package name (used in imports)
version = "1.0.0"               # Semantic versioning
description = "..."             # One-line description
author = "..."                  # Package author
license = "GPL-3.0"             # License (for distribution)
strata = "1.0.0"                # Minimum Strata compiler version

[exports]
string = "./src/string.str"     # Public API modules

[dependencies]
# Other packages this package depends on
# http = "1.2.0"
# crypto = ">=2.0.0,<3.0.0"
```

**Key Rules:**
- Package name must be unique (if publishing to registry)
- `strata` version must match your compiler version
- `exports` define what's accessible when importing the package
- `dependencies` are transitive (but v1.0 disables this for security)

### src/string.str - Implementation

The package implementation contains the actual functions and logic.

```strata
func repeat(s: string, times: int) => string {
  var result: string = ""
  var i: int = 0
  while (i < times) {
    var result: string = result + s
    var i: int = i + 1
  }
  return result
}
```

## Using This Package

### Local Development

In your project's `strata.toml`:

```toml
[dependencies]
string-utils = { path = "../packageexample" }
```

Then import and use:

```strata
import string from string-utils

let result: string = string.repeat("Hi", 3)  // "HiHiHi"
```

### Publishing to Registry

1. Create account on Strata package registry (when available)
2. Increment version in `strata.toml`
3. Run: `strata publish`
4. Package is now available for others to use

Consumers would then use:

```toml
[dependencies]
string-utils = "1.0.0"
```

### Version Ranges

```toml
[dependencies]
# Exact version
string-utils = "1.0.0"

# Range (>=1.0.0 and <2.0.0)
string-utils = ">=1.0.0,<2.0.0"

# Major version (1.x.x)
string-utils = "1.*"

# Latest compatible
string-utils = "*"

# Git repository
string-utils = "git+https://github.com/org/string-utils#v1.0.0"

# Local path (development)
string-utils = { path = "./vendor/string-utils" }
```

## Package Manager Commands

### Creating a new package

```bash
strata init --package
# Creates strata.toml with package template
```

### Adding dependencies

```bash
strata add http 1.2.0
# Updates strata.toml and regenerates strata.lock
```

### Removing dependencies

```bash
strata remove http
# Updates strata.toml and regenerates strata.lock
```

### Updating dependencies

```bash
strata update
# Updates all packages to latest allowed version

strata update http
# Updates only http package
```

### Regenerating lock file

```bash
strata lock
# Regenerates strata.lock from strata.toml
```

### Verifying package integrity

```bash
strata verify
# Checks all packages match hashes in strata.lock
```

## Package Manager Behavior

### Resolution Order

1. Check if package is in local `.strata/cache/`
2. If not, download from:
   - Registry (default)
   - Git repository (if git URL specified)
   - Local path (if path specified)
3. Verify SHA256 hash matches `strata.lock`
4. Extract to `.strata/packages/`

### Security

- **Hash Verification**: All packages verified against lock file
- **No Code Execution**: Package manager never runs code during install
- **Namespace Isolation**: Packages can't shadow `std::` standard library
- **Self-Contained**: v1.0 packages are self-contained (no transitive deps)

### Offline Mode

```bash
strata build --offline
# Only uses packages in .strata/cache/ that match strata.lock
```

## Directory Layout When Consumed

After adding `string-utils` as a dependency:

```
my-project/
├── strata.toml
├── strata.lock
├── src/
│   └── main.str
└── .strata/                    # Generated by package manager
    ├── packages/
    │   └── string-utils/
    │       └── src/
    │           └── string.str
    └── cache/
        └── string-utils-1.0.0.tar.gz
```

The `.strata/` directory is typically git-ignored. Only `strata.toml` and `strata.lock` are committed.

## Example Files in This Directory

- **strata.toml** – The actual package manifest
- **example_project_strata.toml** – What a consumer project looks like
- **example_strata.lock** – Example of generated lock file (don't edit manually)
- **example_usage.str** – How to import and use the package
- **src/string.str** – The package implementation

## Best Practices

1. **Semantic Versioning**: Use MAJOR.MINOR.PATCH (e.g., 1.2.3)
2. **Lock File**: Always commit `strata.lock` to version control
3. **.strata Folder**: Add to `.gitignore` (contains build artifacts)
4. **Clear API**: Use `exports` to define public interface clearly
5. **Type Safe**: Ensure all exported functions have explicit type annotations
6. **Documentation**: Include examples and clear descriptions
7. **License**: Choose appropriate license for distribution

## Status

Strata's package manager is designed to be:
- **Simple**: Minimal configuration, no magic
- **Deterministic**: Same input always produces same output
- **Secure**: Hash verification, no code execution during install
- **Offline-First**: Works without network when packages are cached
- **Future-Proof**: Designed to support centralized registry (v2.0+)
